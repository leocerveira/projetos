"0","carregar_dados <- function(ano) {"
"0","  get_pnadc(year = ano, interview = 1, vars = variaveis, defyear = 2024)"
"0","}"
"0",""
"0","calcula_media <- function(design) {"
"0","  design <- subset(design, cor_raça != ""Ignorado"")"
"0","  "
"0","  design <- update(design, "
"0","                   Renda_dom = rendimento_habitual_domicilio * CO2,"
"0","                   Renda = rendimento_habitual * CO2) "
"0","  "
"0","  renda_ano <- svyby("
"0","    formula = ~Renda,"
"0","    by = ~interaction(sexo, cor_raça),  "
"0","    design = design,"
"0","    FUN = svymean,"
"0","    na.rm = TRUE"
"0","  )"
"0","  "
"0","  renda_ano <- renda_ano %>%"
"0","    rename(Categoria = `interaction(sexo, cor_raça)`) %>%"
"0","    mutate(Categoria = as.character(Categoria))"
"0","  "
"0","  renda_media <- svymean(x = ~Renda, design = design, na.rm = TRUE)"
"0","  "
"0","  renda_geral <- data.frame(""Geral"", coef(renda_media), SE(renda_media))"
"0","  colnames(renda_geral) <- colnames(renda_ano)  # garante consistência"
"0","  "
"0","  renda_ano <- rbind(renda_ano, renda_geral)"
"0","  rownames(renda_ano) <- NULL"
"0","  gc()"
"0","  return(renda_ano)"
"0","}"
"0",""
"0","calcula_quartil <- function(dados) {"
"0","  dado <- dados"
"0","  dado <- subset(dado, !is.na(rendimento_habitual) & !is.na(sexo) & cor_raça != ""Ignorado"")"
"0","  "
"0","  dado <- transform("
"0","    dado,"
"0","    Renda = rendimento_habitual * CO2, "
"0","    Renda_dom = rendimento_habitual_domicilio * CO2, "
"0","    Categoria = interaction(sexo, cor_raça)"
"0","  )"
"0","  "
"0","  quartis <- svyby("
"0","    ~Renda,                      "
"0","    ~Categoria,                      "
"0","    dado,                       "
"0","    FUN = svyquantile,            "
"0","    quantiles = c(0.25, 0.5, 0.75)"
"0","  )"
"0","  "
"0","  dado_df <- as.data.frame(dado$variables)"
"0","  dado_df <- left_join(dado_df, quartis, by = ""Categoria"")"
"0","  "
"0","  quartil_geral <- svyquantile("
"0","    x = ~Renda, "
"0","    design = dado, "
"0","    quantiles = c(0.25, 0.5, 0.75), "
"0","    ci = FALSE"
"0","  )"
"0","  quartil_geral <- as.data.frame(quartil_geral[[""Renda""]])"
"0","  "
"0","  renda_media <- svymean(~Renda, dado) "
"0","  "
"0","  dado_df <- dado_df %>%"
"0","    select(Categoria, Renda, Renda.0.25, Renda.0.5, Renda.0.75) %>%"
"0","    mutate(Categoria = as.character(Categoria))"
"0","  "
"0","  media_geral <- data.frame("
"0","    Categoria = ""Geral"","
"0","    Renda = as.numeric(renda_media[""Renda""]),"
"0","    Renda.0.25 = as.numeric(quartil_geral[1]),"
"0","    Renda.0.5 = as.numeric(quartil_geral[2]),"
"0","    Renda.0.75 = as.numeric(quartil_geral[3]),"
"0","    Quartil = case_when("
"0","      as.numeric(renda_media[""Renda""]) <= as.numeric(quartil_geral[1]) ~ ""Q4"","
"0","      as.numeric(renda_media[""Renda""]) <= as.numeric(quartil_geral[2]) ~ ""Q3"","
"0","      as.numeric(renda_media[""Renda""]) <= as.numeric(quartil_geral[3]) ~ ""Q2"","
"0","      TRUE ~ ""Q1"""
"0","    )"
"0","  )"
"0","  "
"0","  dado_df$Categoria <- factor(dado_df$Categoria)"
"0","  "
"0","  dado_df <- dado_df %>%"
"0","    mutate("
"0","      Quartil = case_when("
"0","        Renda <= Renda.0.25 ~ ""Q4"",            "
"0","        Renda <= Renda.0.5  ~ ""Q3"",            "
"0","        Renda <= Renda.0.75 ~ ""Q2"",            "
"0","        TRUE                ~ ""Q1"""
"0","      )"
"0","    )"
"0","  "
"0","  dado_df <- full_join(dado_df, media_geral)"
"0","  "
"0","  dado_df$Renda <- as.numeric(dado_df$Renda)"
"0","  "
"0","  resultado <- dado_df %>%"
"0","    group_by(Categoria, Quartil) %>% "
"0","    summarize(Media_Renda = mean(Renda)) %>%"
"0","    mutate(Quartil_Geral = case_when("
"0","      Media_Renda <= as.numeric(quartil_geral[1]) ~ ""q4"",            "
"0","      Media_Renda <= as.numeric(quartil_geral[2]) ~ ""q3"",            "
"0","      Media_Renda <= as.numeric(quartil_geral[3]) ~ ""q2"",            "
"0","      TRUE ~ ""q1"""
"0","    ))"
"0","  "
"0","  return(resultado)"
"0","}"
"0",""
"0","# Função para reordenar categorias condicionalmente após pivot_wider"
"0","pivot_reorder <- function(data, ano, variavel, categoria, valor, vars_to_reorder, decrescente = TRUE) {"
"0","  "
"0","  ultimo_ano <- as.character(max(as.numeric(pull(data, {{ano}})), na.rm = TRUE))"
"0","  var_levels <- data %>% pull({{variavel}}) %>% unique()"
"0","  "
"0","  data %>%"
"0","    mutate("
"0","      {{categoria}} := as.character({{categoria}})"
"0","    ) %>%"
"0","    pivot_wider("
"0","      names_from = {{ano}},"
"0","      values_from = {{valor}}"
"0","    ) %>%"
"0","    group_by({{variavel}}) %>%"
"0","    mutate("
"0","      {{categoria}} := if (first({{variavel}}) %in% vars_to_reorder) {"
"0","        fct_reorder("
"0","          .data[[as.character(rlang::ensym(categoria))]],"
"0","          as.numeric(.data[[ultimo_ano]]),"
"0","          .desc = decrescente"
"0","        )"
"0","      } else {"
"0","        factor("
"0","          .data[[as.character(rlang::ensym(categoria))]],"
"0","          levels = unique(.data[[as.character(rlang::ensym(categoria))]])"
"0","        )"
"0","      }"
"0","    ) %>%"
"0","    ungroup() %>%"
"0","    arrange("
"0","      factor(.data[[as.character(rlang::ensym(variavel))]], levels = var_levels),"
"0","      .data[[as.character(rlang::ensym(categoria))]]"
"0","    )"
"0","}"
